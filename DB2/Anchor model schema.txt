-- TYP_GenreType table
CREATE TABLE TYP_GenreType (
    TYP_ID INTEGER NOT NULL,
    TYP_GenreType VARCHAR(25) NOT NULL,
    PRIMARY KEY (TYP_ID),
    UNIQUE (TYP_GenreType)
);

-- RTT_RatingType table
CREATE TABLE RTT_RatingType (
    RTT_ID SMALLINT NOT NULL,
    RTT_RatingType VARCHAR(25) NOT NULL,
    PRIMARY KEY (RTT_ID),
    UNIQUE (RTT_RatingType)
);

-- MV_Movie table
CREATE TABLE MV_Movie (
    MV_ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    MV_Dummy SMALLINT,
    PRIMARY KEY (MV_ID)
);

-- MV_NAM_Movie_Name table
CREATE TABLE MV_NAM_Movie_Name (
    MV_ID INTEGER NOT NULL,
    MV_NAM_Movie_Name VARCHAR(50) NOT NULL,
    PRIMARY KEY (MV_ID),
    FOREIGN KEY (MV_ID) REFERENCES MV_Movie (MV_ID)
);

-- MV_GER_Movie_Gerne table
CREATE TABLE MV_GER_Movie_Gerne (
    MV_ID INTEGER NOT NULL,
    TYP_ID INTEGER NOT NULL,
    PRIMARY KEY (MV_ID),
    FOREIGN KEY (MV_ID) REFERENCES MV_Movie (MV_ID),
    FOREIGN KEY (TYP_ID) REFERENCES TYP_GenreType (TYP_ID)
);

-- MV_ATH_Movie_Author table
CREATE TABLE MV_ATH_Movie_Author (
    MV_ID INTEGER NOT NULL,
    MV_ATH_Movie_Author VARCHAR(50) NOT NULL,
    PRIMARY KEY (MV_ID),
    FOREIGN KEY (MV_ID) REFERENCES MV_Movie (MV_ID)
);

-- MV_RAT_Movie_Rating table
CREATE TABLE MV_RAT_Movie_Rating (
    MV_ID INTEGER NOT NULL,
    RTT_ID SMALLINT NOT NULL,
    MV_RAT_ChangedAt TIMESTAMP NOT NULL,
    PRIMARY KEY (MV_ID, MV_RAT_ChangedAt),
    FOREIGN KEY (MV_ID) REFERENCES MV_Movie (MV_ID),
    FOREIGN KEY (RTT_ID) REFERENCES RTT_RatingType (RTT_ID)
);

-- Index for MV_RAT_Movie_Rating_MV_RAT_ChangedAt
CREATE INDEX MV_RAT_Movie_Rating_MV_RAT_ChangedAt_idx ON MV_RAT_Movie_Rating (MV_RAT_ChangedAt);

-- Views (latest perspective)
CREATE OR REPLACE VIEW lMV_RAT_Movie_Rating AS
SELECT MV_ID, RTT_ID, MV_RAT_ChangedAt
FROM MV_RAT_Movie_Rating;

CREATE OR REPLACE VIEW lMV_Movie AS
SELECT MV.MV_ID, NAM.MV_NAM_Movie_Name, kGER.TYP_GenreType AS TYP_GenreType,
    GER.TYP_ID, ATH.MV_ATH_Movie_Author, RAT.MV_RAT_ChangedAt,
    kRAT.RTT_RatingType AS RTT_RatingType, RAT.RTT_ID
FROM MV_Movie MV
LEFT JOIN MV_NAM_Movie_Name NAM ON NAM.MV_ID = MV.MV_ID
LEFT JOIN MV_GER_Movie_Gerne GER ON GER.MV_ID = MV.MV_ID
LEFT JOIN TYP_GenreType kGER ON kGER.TYP_ID = GER.TYP_ID
LEFT JOIN MV_ATH_Movie_Author ATH ON ATH.MV_ID = MV.MV_ID
LEFT JOIN lMV_RAT_Movie_Rating RAT ON RAT.MV_ID = MV.MV_ID
LEFT JOIN RTT_RatingType kRAT ON kRAT.RTT_ID = RAT.RTT_ID;
